
<!DOCTYPE html>
<html lang="de">

<head>
    <title>Shopping-List</title>
    <link rel="stylesheet" href="styles.css">
 
    <script>
let shoppingfield = document.getElementById("shoppingfield");
let olshopping = document.getElementById("olshopping");
let savedlists = document.getElementById("savedlists");
let shoppingForm = document.getElementById("shopping-form");
let savedProducts = document.getElementById("saved-products");
let savedProductsBody = document.getElementById("saved-products__body");
let toSave = document.getElementById("tosave");

        let shoppingList = {};

function saveshopping() {
    if (olshopping.childElementCount == 5) return;

    if (!shoppingfield.value.length == 0) {

        // Get the product name
        let productName = shoppingfield.value.trim();

        // Check if the product is already in the shopping list
        if (shoppingList[productName]) {
            // If the product already exists, use the existing price
            var price = shoppingList[productName];
        } else {
            // If the product doesn't exist, generate a new price and save it in the shopping list
            price = Math.random() * (59 - 20) + 20;
            shoppingList[productName] = price;
        }

        // Create the list item with the product name and price
        let inputfieldtext = document.createTextNode(productName + " (" + price.toFixed(2) + ' \xA3)');
        let listitem = document.createElement("li");
        listitem.appendChild(inputfieldtext);

        // Add the list item to the shopping list
        olshopping.appendChild(listitem);
        shoppingfield.value = "";
    }
};

// clear the saved list
function clearshopping() {
    while (olshopping.firstChild) {
        olshopping.removeChild(olshopping.firstChild);
    }
}

function updateFinalSum() {
    // create a finalSum variable
    let finalSum = 0;
    // iterate through table (google: "how to iterate through every cell in a table in javacsript")
    let rows = document.getElementsByClassName("productrow");
    for (let i = 0; i < rows.length; i++) {
        let row = rows[i];
        // parse every price and add it to finalsum
        let price = parseFloat(row.dataset.price);
        finalSum += price;
    }
    // update the sum table row with the new final sum
    if (finalSum == 0) {
        document.getElementById("total-cell").innerHTML = "Sum:";
    } else {
        document.getElementById("total-cell").innerHTML = finalSum.toFixed(2)  + ' \xA3';
    }
}

function moveList() {
    // move list from olshopping to savedlists
    // clear olshopping
    let listitem = document.createElement("li");
    let copyOfOlshopping = olshopping.cloneNode(true);
    if (copyOfOlshopping.childElementCount == 0) {
        return;
    }
    listitem.appendChild(copyOfOlshopping);

    // savedlists.appendChild(listitem);

    let shoppingList = document.getElementById("olshopping").childNodes;

    // iterate through list
    for (let child of shoppingList) {
        let row = savedProductsBody.insertRow(0);
        row.className = "productrow";
        let cell1 = row.insertCell(0);
        let cell2 = row.insertCell(1);
        let splitted = child.innerHTML.split('(');
        let name = splitted[0];
        let price = splitted[1];
        row.dataset.price = price;
        price = price.substring(0, price.length - 1);
        cell1.innerHTML = name;
        cell2.innerHTML = price;
    }

    updateFinalSum();

    // clearTimeout
    for (var i = 0; i < shoppingList.length; ++i) {
        $().append(moveList[i] + "<br/>");
        setTimeout(function () {
            // $(cell1).empty();
            // $(cell2).empty();
            $(savedProductsBody).empty();
            $(updateFinalSum).empty();
        }, 30000);
    }
    clearshopping();
    shoppingfield.value = "";
}

  const fileNameInput = document.querySelector('#fileName');

// Auf Submit-Ereignis des Formulars reagieren
document.querySelector('#fileNameForm').addEventListener('submit', function(event) {
  event.preventDefault(); // Standard-Formular-Submit-Verhalten unterdr체cken

  // Den eingegebenen Dateinamen abrufen
  const fileName = fileNameInput.value.trim();

  // Wenn der Benutzer einen Dateinamen eingegeben hat
  if (fileName) {
    // Daten der aktuellen Einkaufsliste abrufen und in eine CSV-채hnliche Struktur umwandeln
    const shoppingListRows = document.querySelectorAll('#saved-products__body .productrow');
    let subtotal = 0;
    const csvData = 'Product,Price,Pound\n' + Array.from(shoppingListRows).map(row => {
      const name = row.querySelector('td:first-child').textContent.trim();
      const priceWithSymbol = row.querySelector('td:last-child').textContent.trim();
      const price = priceWithSymbol.slice(0, -1).trim(); // das letzte Zeichen (Pfund-Symbol) entfernen und Leerzeichen am Anfang und Ende des Strings entfernen
      subtotal += parseFloat(price);
      return `${name},${price},\u00A3`;
    }).join('\n');

    // Eine neue Datei mit dem Dateinamen erstellen und die Daten speichern
    const file = new Blob([csvData], {type: 'text/csv'});
    const fileURL = URL.createObjectURL(file);

    // Eine neue Liste erstellen, um die gespeicherten Einkaufslisten anzuzeigen
    const savedLists = document.querySelector('#saved-lists');
    const newListElement = document.createElement('li')
    const newListLink = document.createElement('a');
    newListLink.href = fileURL;
    newListLink.download = fileName + '.csv'; // Hier wird der Dateiname um ".csv" erweitert
    newListLink.innerHTML = fileName;
    newListElement.appendChild(newListLink);
    savedLists.insertBefore(newListElement, savedLists.firstChild); // Die neue Liste am Anfang der Liste der gespeicherten Listen einf체gen

    // Die Subtotal und Total in der Tabelle aktualisieren
    const subtotalCell = document.createElement('td');
    subtotalCell.innerHTML = "Sum:";
    const totalCell = document.querySelector('#total-cell');
    totalCell.innerHTML = '';
    totalCell.appendChild(subtotalCell);
  }
  fileNameInput.value = "";
});

shoppingForm.addEventListener('submit', e => {
    e.preventDefault();
    console.log('submit');
    moveList();
})

document.getElementById('save').addEventListener('click', () => {
    saveshopping();
})

// Remove Item handler
olshopping.addEventListener('dblclick', (e) => {
    // console.log("dbclick"); 
    e.target.remove();
    if (olshopping.children.length == 0) {
        olshopping.className = '';
    }
});

document.getElementById('clear').addEventListener('click', () => {
    clearshopping();
})


document.onkeydown = function (e) {
    if (e.shiftKey) {
        saveshopping();
    }
}

    </script>
</head>

<body>
    <nav>
        <div class="container-fluid"></div>
        <div class="nav-wrapper">
            <legend><a class="brand-logo center" id="ueberschr">Shopping-List<a></legend>
        </div>
        </div>
    </nav>
    <ul></ul>

    <form id="shopping-form">
        <ol id="olshopping"></ol>
        <div class="mdl-textfield mdl-jstextfield--floating-label">
            <input class="mdl-textfield__input" type="text" placeholder="Produkt einfuegen" value="" id="shoppingfield">
            <div class="row">
                <div class="col-md-6">
                    <button type="button" class="btn btn-primary" id="save">Speichern</button>
                    <button type="button" class="btn btn-warning" id="clear">Loeschen</button>
                    <button type="submit" id="autosave" class="btn btn-danger">Neue Liste</button>
                </div>
            </div>
    </form>

    <ol id="savedlists"></ol>

    <div class="container">
        <div>
            <h3>Saved list:</h3>
            <table id="saved-products" class="table">
                <thead id="saved-products__head" class="thead-dark">
                    <tr>
                        <th>Product</th>
                        <th>Price</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="saved-products__body">
                </tbody>
                <tbody class="amount"> <!--DAS DARF NICHT SO SEIN!!!! Aber mir -->
                    <tr> <!--f채llt keine idee ein "=> zwei tbody"-->
                        <th>All</th>
                        <th id="total-cell">Sum:</th>
                    </tr>
                </tbody>
            </table>
        </div>

        <form id="fileNameForm">
            <label for="fileName"></label>
            <input type="text" id="fileName" name="fileName" placeholder="Enter the file name..." required>
            <button type="submit" class="btn btn-primary">SAVE FILE</button>
        </form>

        <div class="savedLists">
            <ul id="saved-lists"></ul>
            <table>
                <tr>
                    <td></td>
                </tr>
            </table>
        </div>
        <script src="./cacheDoms.js"></script>
        <script src="mainWindow.js"></script>
</body>

</html>